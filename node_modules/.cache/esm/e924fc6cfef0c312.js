let minimist,chalk,version,help,moreInfo;_fef‍.x([["main",()=>main]]);_fef‍.w("minimist",[["default",["minimist"],function(v){minimist=v}]]);_fef‍.w("chalk",[["default",["chalk"],function(v){chalk=v}]]);_fef‍.w("./version",[["version",["version"],function(v){version=v}]]);_fef‍.w("./help",[["help",["help"],function(v){help=v}],["moreInfo",["moreInfo"],function(v){moreInfo=v}]]);




const messages = {
initialMessage: `
${chalk.blueBright('Hello!')}, I'm ${chalk.blueBright('CoffeeCalculator')}
I can tell you how long until your coffee's taste changes.
Before we begin I just have some questions:`,
coffeePreference: `
What kind of ${chalk.greenBright('coffee')} are you drinking?
    Enter 1 for ${chalk.blueBright('flat white')}
    Enter 2 for ${chalk.blueBright('long black')}
    Enter 3 for ${chalk.blueBright('latte')}
    Enter 4 for ${chalk.blueBright('cappuccino')}
    Enter 5 is you'd like me to just run a ${chalk.blueBright('default')} calculation`,
countryError: `
I'm sorry, I wasn't able to find your ${chalk.blueBright('country')}, please try again. If
you would like to quit please press ${chalk.blueBright('Ctrl + C')}. For a list of the acceptable
inputs I use, please refer to ${chalk.magentaBright('https://datahub.io/core/country-list#data')}.`,
cityError: `
I'm sorry, I wasn't able to find your ${chalk.blueBright('city')}, please try again. If
you would like to quit please press ${chalk.blueBright('Ctrl + C')}. For a list of the acceptable
inputs I use, please refer to ${chalk.magentaBright('https://openweathermap.org/')} to find your city.`,
coffeeError: `
Please enter a number within the range of ${chalk.blueBright('1 - 4')}.`
}

       async function main(argsArray) {
    const args = minimist(argsArray.slice(2));
    let cmd = args._[0] || 'help';

    if (args.version || args.v) {
        cmd = 'version';
    }

    if (args.help || args.h) {
        cmd = 'help';
    }

    switch(cmd) {
        case 'version':
            version(args);
            break;

        case 'help':
            help(args);
            break;

        case 'calculate':
            startCalculate(args);
            break;

        case 'more-info':
            moreInfo(args);
            break;

        default:
            console.error(`"${cmd}" is not a valid argument, please try again.`);
            break;
    }
}

async function startCalculate(args) {
    let data = await getWeather();
    displayWeather(data[1]);
    timeMessage(parseFloat(data[0]));
}

function getUserInfo() {
    const prompt = require('prompt-sync')({sigint: true});
    _fef‍.g.console.log(messages.initialMessage);
    let countryName = prompt(`What ${chalk.blueBright('country')} do you live in? -> `);
    let cityName = prompt(`What ${chalk.blueBright('city')} do you live in? -> `);
    _fef‍.g.console.log(messages.coffeePreference);
    let coffeeIndex = prompt();
    return [countryName, cityName, coffeeIndex];
}

async function getWeather() {
    const fetch = require('node-fetch');
    let userData = getUserInfo();
    let countryCode = countryCheck(userData[0]);
    let cityID = cityCheck(userData[1], countryCode);
    var key = '92b30ef73aba0e9531f56ed3e67666a8';
    const response = await fetch('https://api.openweathermap.org/data/2.5/weather?id=' + cityID +
    '&units=metric' + '&appid=' + key);
    const json = await response.json();
    let coffeeTemp = coffeeCheck(userData[2]);
    let celsius = json.main.temp;
    let time = modifiedEuler(celsius, coffeeTemp);
    let data = [time, json];
    return data;
}

function displayWeather(data) {
    let cityName = data.name;
    let celsius = data.main.temp;
    let feelsLike = data.main.feels_like;
    _fef‍.g.console.log(`The ${chalk.blueBright('temperature')} in ` + cityName + ' is currently ' +
    celsius + ` degrees ${chalk.blueBright('Celsius')} however, it most likely\n` +
    `feels like it is ` + feelsLike + ` degrees ${chalk.blueBright('Celsius')}.`);
}

function timeMessage(time) {
    var minutes = Math.floor(time / 60);
    var seconds = time - minutes * 60;
    _fef‍.g.console.log(`The time until the coffee changes ${chalk.blueBright('flavour')} is: ` +
    minutes + ` ${chalk.blueBright('minutes')} and ` + seconds.toFixed(2) + ` ${chalk.blueBright('seconds')}.`);
}

function countryCheck(countryName) {
    var countryData = require('./utilities/countryCodes.json');
    var countryCode = "";

    while (Boolean(countryCode) === false) {
        for (var i = 0; i < countryData.length; i++) {
            var tempName = countryData[i].Name;
            if (tempName === countryName) {
                countryCode = countryData[i].Code;
                break;
            }
        }
    }
    _fef‍.g.console.log(`Your ${chalk.blueBright('country code')} is: `, countryCode);
    return countryCode;
}

function cityCheck(cityName, countryCode) {
    // Function to take text input from user and return a city ID
    var cityData = require('./utilities/city.list.json');
    var cityCode = 0;

    while (Boolean(cityCode) === false) {
        for (var i = 0; i < cityData.length; i++) {
            var tempName = cityData[i].name;
            var tempCountry = cityData[i].country;
            if (cityName === tempName && countryCode === tempCountry) {
                var cityCode = cityData[i].id;
            }
        }
    }

    if (Boolean(cityCode) === false) {
        _fef‍.g.console.log(messages.cityError);
    }
    _fef‍.g.console.log(`Your ${chalk.blueBright('city code')} is: `, cityCode);
    return cityCode;
}

function coffeeCheck(coffeeType) {
    // Function to verify which kind of coffee the user drinks
    var coffeeData = [
        {"name": 'long black', "temperature": '80'},
        {"name": 'flat white', "temperature": '65'},
        {"name": 'latte', "temperature": '60'},
        {"name": 'cappuccino', "temperature": '70'}
    ];
    var coffeeTemperature = 80; // Degrees Celsius

    if (coffeeType >= 1 && coffeeType <= 5) {
        switch (coffeeType) {
            case '1':
                coffeeTemperature = coffeeData[0].temperature;
                break;

            case '2':
                coffeeTemperature = coffeeData[1].temperature;
                break;

            case '3':
                coffeeTemperature = coffeeData[2].temperature;
                break;

            case '4':
                coffeeTemperature = coffeeData[3].temperature;
                break;

            case '5':
                coffeeTemperature = coffeeData[0].temperature;
                break;
        }
    }
    else {
        _fef‍.g.console.log(messages.coffeeError);
    }
    return coffeeTemperature;
}

// Function to approximate the temperature of the coffee using the modified Euler
// method for approximating polynomials.
function modifiedEuler(cityTemperature, coffeeTemperature) {
    // Initialise known parameters
    var startTime = 0;
    var endTime = 40; // Minutes
    var steps = parseFloat(endTime * 60); // Calculate total steps
    var k = 0.1 // Positive constant for equation
    var undrinkable = 40; // Temperature for when a coffee's flavour palette changes
    let stepSize = parseFloat((endTime - startTime) / steps); // Calculate step-size
    var timeArray = new Array(steps);
    var tempArray = new Array(timeArray.length);
    var minutesTotal = 0;

    // Initialise the first position in the temperature array with the coffee serving
    // temperature
    timeArray[0] = parseFloat(startTime);
    tempArray[0] = coffeeTemperature;

    // Fill 'timeArray' with time incrementing by step size
    for (var i = 1; i < timeArray.length; i++) {
        timeArray[i] = parseFloat(timeArray[i - 1] + stepSize);
        //console.log(timeArray);
    }

    // Approximate the coffee temperature at each corresponding point in 'timeArray'
    for (var j = 0; j < tempArray.length - 1; j++) {
        var k1 = stepSize * ((k * -1) * (parseFloat(tempArray[j]) - parseFloat(cityTemperature)));
        var k2 = stepSize * ((k * -1) * (parseFloat(tempArray[j]) + k1 - parseFloat(cityTemperature)));
        tempArray[j + 1] = parseFloat(tempArray[j]) + 1/2 * parseFloat((k1 + k2));
    }

    // Perform iterations via for loop to calculate the time taken for the coffee
    // to become "undrinkable".
    for (var k = 0; k < tempArray.length; k++) {
        let temperature = tempArray[k];
        if (temperature < undrinkable) {
            minutesTotal = timeArray[k];
            break;
        }
    }

    var timeRemaining = minutesTotal * 60; // Calculate the time remaining
    return timeRemaining; // Assign time until coffee is cold in seconds
}